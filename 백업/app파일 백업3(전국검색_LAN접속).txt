from flask import Flask, render_template, request, redirect, url_for, flash, send_file, jsonify
from flask_login import LoginManager, login_user, logout_user, login_required, current_user
from werkzeug.security import generate_password_hash, check_password_hash
from models import db, User, Search
from datetime import datetime, timedelta
from functools import wraps
from flask_wtf.csrf import CSRFProtect
import os
import requests
import json
import time
import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter
import urllib3
from io import BytesIO
from openpyxl import Workbook
from forms import LoginForm, RegistrationForm
import pandas as pd

app = Flask(__name__)
app.config['SECRET_KEY'] = 'your-secret-key-here'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///site.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

# Initialize extensions
db.init_app(app)
csrf = CSRFProtect(app)
login_manager = LoginManager(app)
login_manager.login_view = 'login'
login_manager.login_message = 'ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.'

# Suppress InsecureRequestWarning
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Constants
TRADE_TYPE_MAPPING = {
    "ì „ì²´": "",
    "ë§¤ë§¤": "A1",
    "ì „ì„¸": "B1",
    "ì›”ì„¸": "B2"
}

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

def check_subscription():
    if current_user.is_admin or current_user.is_premium:
        return True
    if current_user.subscription_expiry and datetime.utcnow() < current_user.subscription_expiry:
        return True
    return False

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/register', methods=['GET', 'POST'])
def register():
    if current_user.is_authenticated:
        return redirect(url_for('dashboard'))
    
    form = RegistrationForm()
    if form.validate_on_submit():
        user = User(username=form.username.data, 
                   email=form.email.data, 
                   password=form.password.data)
        db.session.add(user)
        db.session.commit()
        flash('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'success')
        return redirect(url_for('login'))
    return render_template('register.html', form=form)

@app.route('/login', methods=['GET', 'POST'])
def login():
    if current_user.is_authenticated:
        return redirect(url_for('dashboard'))
    
    form = LoginForm()
    if form.validate_on_submit():
        user = User.query.filter_by(email=form.email.data).first()
        if user and user.check_password(form.password.data):
            login_user(user, remember=form.remember.data)
            user.last_login = datetime.utcnow()
            db.session.commit()
            flash('ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
            next_page = request.args.get('next')
            return redirect(next_page) if next_page else redirect(url_for('dashboard'))
        else:
            flash('ë¡œê·¸ì¸ ì‹¤íŒ¨. ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'danger')
    return render_template('login.html', form=form)

@app.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('index'))

@app.route('/dashboard')
@login_required
def dashboard():
    if not check_subscription():
        flash('ì²´í—˜ ê¸°ê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.')
        return redirect(url_for('index'))
    return render_template('dashboard.html')

@app.route('/search', methods=['POST'])
@login_required
def search():
    """ì•„íŒŒíŠ¸ ë‹¨ì§€ ê²€ìƒ‰ API"""
    if not current_user.is_active:
        return jsonify({'error': 'ê³„ì •ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'}), 403
        
    if not check_subscription():
        return jsonify({'error': 'êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'}), 403
        
    try:
        # JSON ìš”ì²­ê³¼ form ë°ì´í„° ëª¨ë‘ ì²˜ë¦¬
        if request.is_json:
            data = request.get_json()
            keyword = data.get('keyword', '').strip()
        else:
            keyword = request.form.get('keyword', '').strip()
        
        if not keyword:
            return jsonify({'error': 'ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'}), 400
            
        print(f"[DEBUG] Searching for keyword: {keyword}")
        
        # ë‹¨ì§€ ê²€ìƒ‰
        complexes = get_complexes_by_region(keyword)
        if not complexes:
            print(f"[DEBUG] No complexes found for keyword: {keyword}")
            return jsonify({'error': 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}), 404
            
        # ì‘ë‹µ ë°ì´í„° ê°€ê³µ
        result = [{
            'complexNo': complex.get('complexNo'),
            'complexName': complex.get('complexName'),
            'address': f"{complex.get('address', '')} {complex.get('detailAddress', '')}".strip(),
            'totalHouseholdCount': complex.get('totalHouseholdCount'),
            'completionYearMonth': complex.get('completionYearMonth')
        } for complex in complexes if complex.get('complexNo')]
        
        if not result:
            print(f"[DEBUG] No valid complexes after processing")
            return jsonify({'error': 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}), 404
            
        print(f"[DEBUG] Found {len(result)} complexes")
        return jsonify({'complexes': result})
        
    except requests.exceptions.RequestException as e:
        print(f"[ERROR] Network error: {str(e)}")
        return jsonify({'error': 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}), 500
    except json.JSONDecodeError as e:
        print(f"[ERROR] JSON decode error: {str(e)}")
        return jsonify({'error': 'ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}), 500
    except Exception as e:
        print(f"[ERROR] Unexpected error: {str(e)}")
        return jsonify({'error': f'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'}), 500

def get_complexes_by_region(keyword):
    """ë„¤ì´ë²„ ë¶€ë™ì‚° APIë¥¼ í†µí•´ ì•„íŒŒíŠ¸ ë‹¨ì§€ ê²€ìƒ‰"""
    try:
        cookies = {
            'NNB': 'FGYNFS4Y6M6WO',
            'NFS': '2',
            'ASID': 'afd10077000001934e8033f50000004e',
            'ba.uuid': 'a5e52e8f-1775-4eea-9b42-30223205f9df',
            'tooltipDisplayed': 'true',
            'nstore_session': 'zmRE1M3UHwL1GmMzBg0gfcKH',
            '_fwb': '242x1Ggncj6Dnv0G6JF6g8h.1738045585397',
            'landHomeFlashUseYn': 'N',
            'REALESTATE': 'Thu Apr 03 2025 20:14:11 GMT+0900 (Korean Standard Time)',
            'NACT': '1',
        }
        headers = {
            'accept': '*/*',
            'accept-language': 'ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7',
            'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IlJFQUxFU1RBVEUiLCJpYXQiOjE3MzgwNDcxNjMsImV4cCI6MTczODA1Nzk2M30.Heq-J33LY9pJDnYOqmRhTTrSPqCpChtWxka_XUphnd4',
            'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36',
        }
        params = {'keyword': keyword, 'page': '1'}
        url = 'https://new.land.naver.com/api/search'
        print(f"[DEBUG] ì§€ì—­ ê²€ìƒ‰ API ìš”ì²­: {url} with params={params}")
        
        session = requests.Session()
        session.headers.update(headers)
        session.cookies.update(cookies)
        
        # ì„¸ì…˜ ì´ˆê¸°í™”
        init_url = 'https://new.land.naver.com/complexes'
        init_response = session.get(init_url, verify=False, timeout=10)
        print(f"[DEBUG] Initial request status: {init_response.status_code}")
        if init_response.status_code != 200:
            print(f"[ERROR] Initial request failed: {init_response.text[:500]}")
            return []
            
        response = session.get(url, params=params, verify=False, timeout=10)
        print(f"[DEBUG] API response status: {response.status_code}")
        if response.status_code != 200:
            print(f"[ERROR] API request failed: {response.text[:500]}")
            return []
            
        # JSON íŒŒì‹± ì „ ì‘ë‹µ ë‚´ìš© ì¼ë¶€ ë¡œê·¸
        response_text = response.text[:500]
        print(f"[DEBUG] API response preview: {response_text}")
        
        data = response.json()
        complexes = data.get('complexes', [])
        if not complexes:
            print(f"[DEBUG] No complexes in response")
            return []
            
        complexes.sort(key=lambda x: x['complexName'])
        print(f"[DEBUG] Found {len(complexes)} complexes")
        return complexes
    except requests.exceptions.RequestException as e:
        print(f"[ERROR] Request error: {str(e)}")
        return []
    except json.JSONDecodeError as e:
        print(f"[ERROR] JSON decode error: {str(e)}, response: {response.text[:500] if 'response' in locals() else 'N/A'}")
        return []
    except Exception as e:
        print(f"[ERROR] API error: {str(e)}")
        return []

def get_real_estate_data(complex_no, trade_type, page=1):
    """ë§¤ë¬¼ ë°ì´í„° ì¡°íšŒ"""
    try:
        cookies = {
            'NNB': 'FGYNFS4Y6M6WO',
            'NFS': '2',
            'ASID': 'afd10077000001934e8033f50000004e',
            'ba.uuid': 'a5e52e8f-1775-4eea-9b42-30223205f9df',
            'tooltipDisplayed': 'true',
            'nstore_session': 'zmRE1M3UHwL1GmMzBg0gfcKH',
            'nstore_pagesession': 'iH4K+dqWcpYFllsM1U4-116496',
            'NAC': 'XfPpC4A0XeLCA',
            'page_uid': 'iHmGBsqVN8ossOXBRrlsssssswV-504443',
            'nhn.realestate.article.rlet_type_cd': 'A01',
            'nhn.realestate.article.trade_type_cd': '""',
            'nhn.realestate.article.ipaddress_city': '1100000000',
            '_fwb': '242x1Ggncj6Dnv0G6JF6g8h.1738045585397',
            'realestate.beta.lastclick.cortar': '1174010900',
            'landHomeFlashUseYn': 'N',
            'BUC': 'fwUJCqRUIsM47V0-Lcz1VazTR9EQgUrBIxM1P_x9Id4=',
            'REALESTATE': 'Tue Jan 28 2025 16:23:02 GMT+0900 (Korean Standard Time)',
            'NACT': '1',
        }
        headers = {
            'accept': '*/*',
            'accept-language': 'ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7',
            'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IlJFQUxFU1RBVEUiLCJpYXQiOjE3MzgwNDcxNjMsImV4cCI6MTczODA1Nzk2M30.Heq-J33LY9pJDnYOqmRhTTrSPqCpChtWxka_XUphnd4',
            'referer': f'https://new.land.naver.com/complexes/{complex_no}',
            'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36',
        }
        url = f'https://new.land.naver.com/api/articles/complex/{complex_no}'
        params = {
            'realEstateType': 'APT:PRE:ABYG:JGC',
            'tradeType': trade_type,
            'tag': '::::::::',
            'rentPriceMin': '0',
            'rentPriceMax': '900000000',
            'priceMin': '0',
            'priceMax': '900000000',
            'areaMin': '0',
            'areaMax': '900000000',
            'showArticle': 'false',
            'sameAddressGroup': 'false',
            'priceType': 'RETAIL',
            'page': str(page),
            'complexNo': str(complex_no),
            'type': 'list',
            'order': 'rank'
        }
        print(f"[DEBUG] API ìš”ì²­ ì‹œì‘: {url} with params={params}")
        session = requests.Session()
        session.headers.update(headers)
        session.cookies.update(cookies)
        
        # ì„¸ì…˜ ì´ˆê¸°í™”
        init_url = f'https://new.land.naver.com/complexes/{complex_no}'
        init_response = session.get(init_url, verify=False, timeout=10)
        print(f"[DEBUG] Initial request status: {init_response.status_code}")
        if init_response.status_code != 200:
            print(f"[ERROR] Initial request failed: {init_response.text[:500]}")
            return None
            
        response = session.get(url, params=params, verify=False, timeout=10)
        print(f"[DEBUG] API response status: {response.status_code}")
        if response.status_code != 200:
            print(f"[ERROR] API request failed: {response.text[:500]}")
            return None
            
        data = response.json()
        print(f"[DEBUG] API ì‘ë‹µ ì„±ê³µ: ìƒíƒœ ì½”ë“œ {response.status_code}")
        return data
    except json.JSONDecodeError as e:
        print(f"[ERROR] JSON decode error: {str(e)}, response: {response.text[:500] if 'response' in locals() else 'N/A'}")
        return None
    except Exception as e:
        print(f"[ERROR] Error: {str(e)}")
        return None

def process_data(data):
    """ë§¤ë¬¼ ë°ì´í„° ì²˜ë¦¬"""
    if not data:
        print("[DEBUG] ì²˜ë¦¬í•  ë°ì´í„° ì—†ìŒ")
        return []
    articles = data.get('articleList', [])
    if not articles:
        print("[DEBUG] articleListê°€ ë¹„ì–´ ìˆìŒ")
    processed_data = []
    for article in articles:
        tags = ', '.join(article.get('tagList', [])) if article.get('tagList') else ''
        processed_article = {
            'ìˆœë²ˆ': 'N/A',
            'ì•„íŒŒíŠ¸ëª…': article.get('articleName'),
            'ê±°ë˜ìœ í˜•': article.get('tradeTypeName'),
            'ì¸µìˆ˜': article.get('floorInfo'),
            'ì›”ì„¸': article.get('rentPrc'),
            'ê±°ë˜ê°€ê²©': article.get('dealOrWarrantPrc'),
            'ë©´ì (mÂ²)': article.get('area2'),
            'ë°©í–¥': article.get('direction'),
            'ë“±ë¡ì¼': article.get('articleConfirmYmd'),
            'ë™': article.get('buildingName'),
            'ì¤‘ê°œì‚¬ë¬´ì†Œ': article.get('realtorName'),
            'íŠ¹ì§•': tags
        }
        processed_data.append(processed_article)
    print(f"[DEBUG] ì²˜ë¦¬ëœ ë§¤ë¬¼ ìˆ˜: {len(processed_data)}")
    return processed_data

def fetch_all_pages(complex_no, trade_type):
    """ëª¨ë“  í˜ì´ì§€ì˜ ë§¤ë¬¼ ë°ì´í„° ìˆ˜ì§‘"""
    all_data = []
    page = 1
    while True:
        print(f"[DEBUG] ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (í˜ì´ì§€ {page})")
        response_data = get_real_estate_data(complex_no, trade_type, page)
        if not response_data or not response_data.get('articleList'):
            print(f"[DEBUG] í˜ì´ì§€ {page}ì—ì„œ ë°ì´í„° ì—†ìŒ ë˜ëŠ” articleList ë¹„ì–´ ìˆìŒ")
            break
        processed_data = process_data(response_data)
        all_data.extend(processed_data)
        if not response_data.get('isMoreData', False):
            print(f"[DEBUG] ë” ì´ìƒ ë°ì´í„° ì—†ìŒ")
            break
        page += 1
        time.sleep(1)
    all_data.sort(key=lambda x: x['ë“±ë¡ì¼'] if x['ë“±ë¡ì¼'] else '99999999')
    print(f"[DEBUG] ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ. ì´ {len(all_data)}ê°œ ë§¤ë¬¼ ë°œê²¬.")
    return all_data

@app.route('/fetch_data', methods=['POST'])
@login_required
def fetch_data():
    """ë§¤ë¬¼ ë°ì´í„° ì¡°íšŒ API"""
    if not check_subscription():
        return jsonify({'error': 'êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'}), 403
        
    try:
        data = request.get_json()
        if not data:
            return jsonify({'error': 'ìš”ì²­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'}), 400
            
        complex_no = data.get('complex_no')
        trade_type = data.get('trade_type', '')
        
        if not complex_no:
            return jsonify({'error': 'ë‹¨ì§€ ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.'}), 400
            
        # ê±°ë˜ ìœ í˜• ì½”ë“œ ë³€í™˜
        trade_type_code = TRADE_TYPE_MAPPING.get(trade_type, '')
        
        # ë‹¨ì§€ ì •ë³´ ì¡°íšŒ
        complex_info = get_complex_info(complex_no)
        if not complex_info:
            return jsonify({'error': 'ë‹¨ì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}), 404
            
        # ë§¤ë¬¼ ëª©ë¡ ì¡°íšŒ
        article_list = get_article_list(complex_no, trade_type_code)
        if not article_list:
            return jsonify({'error': 'ë§¤ë¬¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}), 404
            
        # ë°ì´í„° ì²˜ë¦¬
        processed_data = []
        for article in article_list.get('articleList', []):
            print("\nğŸ” ì›ë³¸ article ë°ì´í„°:")
            print(article)
            
            price_info = get_price_info(article)
            
            # ì¸µìˆ˜ ì •ë³´ ì²˜ë¦¬
            floor_info = article.get('floorInfo', '')
            if floor_info:
                if '/' in floor_info:  # "3/15" í˜•íƒœì¸ ê²½ìš°
                    current_floor = floor_info.split('/')[0]
                    floor_display = f"{current_floor}ì¸µ"
                else:
                    floor_display = f"{floor_info}ì¸µ"
            else:
                floor_display = '-'
            
            item = {
                'ê±°ë˜ìœ í˜•': article.get('tradeTypeName', '-'),
                'ë™': article.get('buildingName', '-'),
                'ì¸µìˆ˜': floor_display,
                'ì „ìš©ë©´ì ': article.get('area2', '-'),
                'ë°©í–¥': article.get('direction', '-'),
                'ê±°ë˜ê°€ê²©': price_info['ê±°ë˜ê°€ê²©'],
                'ì›”ì„¸': price_info['ì›”ì„¸'],
                'ì¤‘ê°œì‚¬ë¬´ì†Œ': article.get('realtorName', '-'),
                'ë“±ë¡ì¼': article.get('articleConfirmYmd', '-'),
                'íŠ¹ì§•': ', '.join(article.get('tagList', [])) or '-',
                'íŠ¹ì§•ì„¤ëª…': article.get('articleFeatureDesc', '')
            }
            processed_data.append(item)
            
        print("\nğŸ“¦ ìµœì¢… ê°€ê³µëœ ë°ì´í„°:")
        for item in processed_data:
            print(item)
            
        return jsonify({'data': processed_data})
        
    except Exception as e:
        print(f"[ERROR] Error in fetch_data: {str(e)}")
        return jsonify({'error': f'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'}), 500

@app.route('/download_excel', methods=['POST'])
@login_required
def download_excel():
    """ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ"""
    if not check_subscription():
        return jsonify({'error': 'êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'}), 403
        
    try:
        data = request.get_json()
        if not data:
            return jsonify({'error': 'ìš”ì²­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'}), 400
            
        complex_no = data.get('complex_no')
        trade_type = data.get('trade_type', '')
        
        if not complex_no:
            return jsonify({'error': 'ë‹¨ì§€ ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.'}), 400
            
        # ë‹¨ì§€ ì •ë³´ ì¡°íšŒ
        complex_info = get_complex_info(complex_no)
        if not complex_info:
            return jsonify({'error': 'ë‹¨ì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}), 404
            
        # ë§¤ë¬¼ ëª©ë¡ ì¡°íšŒ
        article_list = get_article_list(complex_no, TRADE_TYPE_MAPPING.get(trade_type, ''))
        if not article_list:
            return jsonify({'error': 'ë§¤ë¬¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}), 404
            
        # ì—‘ì…€ íŒŒì¼ ìƒì„±
        wb = Workbook()
        ws = wb.active
        ws.title = complex_info.get('complexName', 'ë§¤ë¬¼ì •ë³´')
        
        # í—¤ë” ìŠ¤íƒ€ì¼ ì„¤ì •
        header_fill = PatternFill(start_color='E2EFDA', end_color='E2EFDA', fill_type='solid')
        header_font = Font(bold=True)
        thin_border = Border(
            left=Side(style='thin'),
            right=Side(style='thin'),
            top=Side(style='thin'),
            bottom=Side(style='thin')
        )
        center_alignment = Alignment(horizontal='center', vertical='center')
        
        # í—¤ë” ì¶”ê°€
        headers = ['ìˆœë²ˆ', 'ê±°ë˜ìœ í˜•', 'ë™', 'ì¸µìˆ˜', 'ì „ìš©ë©´ì ', 'ë°©í–¥', 'ê±°ë˜ê°€ê²©', 'ì›”ì„¸', 'ì¤‘ê°œì‚¬ë¬´ì†Œ', 'ë“±ë¡ì¼']
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col)
            cell.value = header
            cell.font = header_font
            cell.fill = header_fill
            cell.border = thin_border
            cell.alignment = center_alignment
            
        # ë°ì´í„° ì¶”ê°€
        articles = article_list.get('articleList', [])
        for row, article in enumerate(articles, 2):
            price_info = get_price_info(article)
            
            # ì¸µìˆ˜ ì •ë³´ ì²˜ë¦¬
            floor_info = article.get('floorInfo', '')
            if floor_info:
                if '/' in floor_info:  # "3/15" í˜•íƒœì¸ ê²½ìš°
                    current_floor = floor_info.split('/')[0]
                    floor_display = f"{current_floor}ì¸µ"
                else:
                    floor_display = f"{floor_info}ì¸µ"
            else:
                floor_display = '-'
            
            # ë°ì´í„° ì…ë ¥ ë° ìŠ¤íƒ€ì¼ ì ìš©
            row_data = [
                row-1,  # ìˆœë²ˆ
                article.get('tradeTypeName', '-'),
                article.get('buildingName', '-'),
                floor_display,
                f"{article.get('area2', '-')}ã¡",
                article.get('direction', '-'),
                price_info['ê±°ë˜ê°€ê²©'],
                price_info['ì›”ì„¸'],
                article.get('realtorName', '-'),
                article.get('articleConfirmYmd', '-')
            ]
            
            for col, value in enumerate(row_data, 1):
                cell = ws.cell(row=row, column=col)
                cell.value = value
                cell.border = thin_border
                cell.alignment = center_alignment
                
        # ì—´ ë„ˆë¹„ ìë™ ì¡°ì •
        for col in ws.columns:
            max_length = 0
            column = col[0].column_letter
            
            for cell in col:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
                    
            adjusted_width = (max_length + 2) * 1.2
            ws.column_dimensions[column].width = adjusted_width
            
        # í•„í„° ì„¤ì •
        ws.auto_filter.ref = ws.dimensions
        
        # ë©”ëª¨ë¦¬ì— ì—‘ì…€ íŒŒì¼ ì €ì¥
        excel_file = BytesIO()
        wb.save(excel_file)
        excel_file.seek(0)
        
        # íŒŒì¼ëª…ì— ì•„íŒŒíŠ¸ ì´ë¦„ê³¼ í˜„ì¬ ì‹œê°„ ì¶”ê°€
        filename = f"{complex_info.get('complexName', 'ë§¤ë¬¼ì •ë³´')}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
        
        return send_file(
            excel_file,
            mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            as_attachment=True,
            download_name=filename
        )
        
    except Exception as e:
        print(f"[ERROR] Error in download_excel: {str(e)}")
        return jsonify({'error': f'ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'}), 500

def get_price_info(article):
    deal = article.get('dealOrWarrantPrc', 'ì—†ìŒ')
    rent = article.get('rentPrc', 'ì—†ìŒ')
    trade = article.get('tradeTypeName', 'ì—†ìŒ')

    print(f"[DEBUG] ê±°ë˜ìœ í˜•: {trade} / ê±°ë˜ê°€: {deal} / ì›”ì„¸: {rent}")
    
    if trade == 'ì›”ì„¸':
        return {
            'ê±°ë˜ê°€ê²©': f"{deal}",
            'ì›”ì„¸': f"{rent}"
        }
    else:
        return {
            'ê±°ë˜ê°€ê²©': f"{deal}",
            'ì›”ì„¸': '-'
        }

def format_price(price):
    """ê°€ê²©ì„ í¬ë§·íŒ…í•˜ëŠ” í•¨ìˆ˜"""
    try:
        if not price or price == '0':
            return '-'
            
        price = int(price)
        if price >= 10000:
            ì–µ = price // 10000
            ë§Œ = price % 10000
            if ë§Œ > 0:
                return f"{ì–µ}ì–µ {ë§Œ:,}ë§Œì›"
            return f"{ì–µ}ì–µì›"
        else:
            return f"{price:,}ë§Œì›"
    except:
        return '-'

def admin_required(f):
    @wraps(f)
    @login_required
    def decorated_function(*args, **kwargs):
        if not current_user.is_admin:
            flash('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'danger')
            return redirect(url_for('index'))
        return f(*args, **kwargs)
    return decorated_function

@app.route('/admin')
@admin_required
def admin_dashboard():
    page = request.args.get('page', 1, type=int)
    users = User.query.paginate(page=page, per_page=10)
    total_users = User.query.count()
    active_users = User.query.filter_by(account_status='í™œì„±').count()
    trial_users = User.query.filter_by(is_premium=False).count()
    premium_users = User.query.filter_by(is_premium=True).count()
    
    return render_template('admin_dashboard.html',
                         users=users,
                         total_users=total_users,
                         active_users=active_users,
                         trial_users=trial_users,
                         premium_users=premium_users)

@app.route('/admin/toggle_subscription/<int:user_id>', methods=['POST'])
@admin_required
def toggle_subscription(user_id):
    user = User.query.get_or_404(user_id)
    if not user.is_admin:
        data = request.get_json()
        is_premium = data.get('is_premium', False)
        
        user.is_premium = is_premium
        if is_premium:
            user.subscription_expiry = datetime.utcnow() + timedelta(days=36500)
        else:
            user.subscription_expiry = datetime.utcnow() + timedelta(days=1)
            
        db.session.commit()
        return jsonify({'success': True})
    
    return jsonify({'success': False, 'error': 'ê´€ë¦¬ì ê³„ì •ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'})

@app.route('/admin/extend_subscription/<int:user_id>', methods=['POST'])
@admin_required
def extend_subscription(user_id):
    user = User.query.get_or_404(user_id)
    if not user.is_admin:
        data = request.get_json()
        is_premium = data.get('is_premium', False)
        period = data.get('period')
        
        user.is_premium = is_premium
        
        if is_premium:
            user.subscription_expiry = datetime.utcnow() + timedelta(days=36500)
        elif period:
            current_time = datetime.utcnow()
            if period == '1ì¼ë¡œ ì´ˆê¸°í™”':
                user.subscription_expiry = current_time + timedelta(days=1)
            elif period == '1ì¼':
                if user.subscription_expiry and user.subscription_expiry > current_time:
                    user.subscription_expiry += timedelta(days=1)
                else:
                    user.subscription_expiry = current_time + timedelta(days=1)
            elif period == '7ì¼':
                if user.subscription_expiry and user.subscription_expiry > current_time:
                    user.subscription_expiry += timedelta(days=7)
                else:
                    user.subscription_expiry = current_time + timedelta(days=7)
            elif period == '30ì¼':
                if user.subscription_expiry and user.subscription_expiry > current_time:
                    user.subscription_expiry += timedelta(days=30)
                else:
                    user.subscription_expiry = current_time + timedelta(days=30)
        
        db.session.commit()
        return jsonify({'success': True})
    
    return jsonify({'success': False, 'error': 'ê´€ë¦¬ì ê³„ì •ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'})

@app.route('/admin/toggle_account_status/<int:user_id>')
@admin_required
def toggle_account_status(user_id):
    user = User.query.get_or_404(user_id)
    user.account_status = 'ì •ì§€' if user.account_status == 'í™œì„±' else 'í™œì„±'
    db.session.commit()
    return jsonify({'success': True, 'new_status': user.account_status})

def create_admin():
    """Create an admin user if it doesn't exist."""
    try:
        admin = User.query.filter_by(email='admin@example.com').first()
        if not admin:
            admin = User(
                username='Administrator',
                email='admin@example.com',
                password='admin123!@#',
                is_admin=True
            )
            db.session.add(admin)
            db.session.commit()
            print("ê´€ë¦¬ì ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
        else:
            print("ê´€ë¦¬ì ê³„ì •ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.")
    except Exception as e:
        print(f"ê´€ë¦¬ì ê³„ì • ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        db.session.rollback()

@app.route('/account')
@login_required
def account():
    return render_template('account.html')

@app.route('/change_password', methods=['POST'])
@login_required
def change_password():
    current_password = request.form.get('current_password')
    new_password = request.form.get('new_password')
    confirm_password = request.form.get('confirm_password')
    
    if not current_user.check_password(current_password):
        flash('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'danger')
        return redirect(url_for('account'))
        
    if new_password != confirm_password:
        flash('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',Nelson, 'danger')
        return redirect(url_for('account'))
        
    if len(new_password) < 8:
        flash('ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'danger')
        return redirect(url_for('account'))
        
    current_user.password = generate_password_hash(new_password)
    db.session.commit()
    flash('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
    return redirect(url_for('account'))

def get_complex_info(complex_no):
    """ì•„íŒŒíŠ¸ ë‹¨ì§€ ìƒì„¸ ì •ë³´ ì¡°íšŒ"""
    try:
        cookies = {
            'NNB': 'FGYNFS4Y6M6WO',
            'NFS': '2',
            'ASID': 'afd10077000001934e8033f50000004e',
            'ba.uuid': 'a5e52e8f-1775-4eea-9b42-30223205f9df',
            'tooltipDisplayed': 'true',
            'nstore_session': 'zmRE1M3UHwL1GmMzBg0gfcKH',
            '_fwb': '242x1Ggncj6Dnv0G6JF6g8h.1738045585397',
            'landHomeFlashUseYn': 'N',
            'REALESTATE': 'Thu Apr 03 2025 20:14:11 GMT+0900 (Korean Standard Time)',
            'NACT': '1',
        }
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36',
            'Referer': f'https://new.land.naver.com/complexes/{complex_no}',
            'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IlJFQUxFU1RBVEUiLCJpYXQiOjE3MzgwNDcxNjMsImV4cCI6MTczODA1Nzk2M30.Heq-J33LY9pJDnYOqmRhTTrSPqCpChtWxka_XUphnd4',
            'accept': '*/*',
            'accept-language': 'ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7',
        }
        
        session = requests.Session()
        session.headers.update(headers)
        session.cookies.update(cookies)
        
        init_url = f'https://new.land.naver.com/complexes/{complex_no}'
        init_response = session.get(init_url, verify=False, timeout=10)
        print(f"[DEBUG] Initial request status: {init_response.status_code}")
        if init_response.status_code != 200:
            print(f"[ERROR] Initial request failed: {init_response.text[:500]}")
            return None
            
        url = f'https://new.land.naver.com/api/complexes/overview/{complex_no}'
        response = session.get(url, verify=False, timeout=10)
        print(f"[DEBUG] Complex info API status: {response.status_code}")
        if response.status_code != 200:
            print(f"[ERROR] Complex info request failed: {response.text[:500]}")
            return None
            
        data = response.json()
        print(f"[DEBUG] Complex info response: {data}")
        return data
    except json.JSONDecodeError as e:
        print(f"[ERROR] JSON decode error in get_complex_info: {str(e)}, response: {response.text[:500] if 'response' in locals() else 'N/A'}")
        return None
    except Exception as e:
        print(f"[ERROR] Error in get_complex_info: {str(e)}")
        return None

def get_article_list(complex_no, trade_type='', page=1):
    """ë§¤ë¬¼ ëª©ë¡ ì¡°íšŒ"""
    try:
        cookies = {
            'NNB': 'FGYNFS4Y6M6WO',
            'NFS': '2',
            'ASID': 'afd10077000001934e8033f50000004e',
            'ba.uuid': 'a5e52e8f-1775-4eea-9b42-30223205f9df',
            'tooltipDisplayed': 'true',
            'nstore_session': 'zmRE1M3UHwL1GmMzBg0gfcKH',
            '_fwb': '242x1Ggncj6Dnv0G6JF6g8h.1738045585397',
            'landHomeFlashUseYn': 'N',
            'REALESTATE': 'Thu Apr 03 2025 20:14:11 GMT+0900 (Korean Standard Time)',
            'NACT': '1',
        }
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36',
            'Referer': f'https://new.land.naver.com/complexes/{complex_no}',
            'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IlJFQUxFU1RBVEUiLCJpYXQiOjE3MzgwNDcxNjMsImV4cCI6MTczODA1Nzk2M30.Heq-J33LY9pJDnYOqmRhTTrSPqCpChtWxka_XUphnd4',
            'accept': '*/*',
            'accept-language': 'ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7',
        }
        
        session = requests.Session()
        session.headers.update(headers)
        session.cookies.update(cookies)
        
        init_url = f'https://new.land.naver.com/complexes/{complex_no}'
        init_response = session.get(init_url, verify=False, timeout=10)
        print(f"[DEBUG] Initial request status: {init_response.status_code}")
        if init_response.status_code != 200:
            print(f"[ERROR] Initial request failed: {init_response.text[:500]}")
            return None
            
        all_articles = []
        current_page = 1
        
        while True:
            url = f'https://new.land.naver.com/api/articles/complex/{complex_no}'
            params = {
                'realEstateType': 'APT:ABYG:JGC:PRE',
                'tradeType': trade_type,
                'tag': '::::::::',
                'rentPriceMin': '0',
                'rentPriceMax': '900000000',
                'priceMin': '0',
                'priceMax': '900000000',
                'areaMin': '0',
                'areaMax': '900000000',
                'showArticle': 'false',
                'sameAddressGroup': 'false',
                'priceType': 'RETAIL',
                'page': str(current_page),
                'complexNo': str(complex_no),
                'type': 'list',
                'order': 'rank'
            }
            
            response = session.get(url, params=params, verify=False, timeout=10)
            print(f"[DEBUG] Article list API status (page {current_page}): {response.status_code}")
            if response.status_code != 200:
                print(f"[ERROR] Article list request failed: {response.text[:500]}")
                return None
                
            try:
                data = response.json()
            except json.JSONDecodeError as e:
                print(f"[ERROR] JSON decode error in get_article_list: {str(e)}, response: {response.text[:500]}")
                return None
                
            articles = data.get('articleList', [])
            if not articles:
                print(f"[DEBUG] No articles on page {current_page}")
                break
                
            all_articles.extend(articles)
            
            if not data.get('isMoreData', False):
                print(f"[DEBUG] No more data after page {current_page}")
                break
                
            current_page += 1
            time.sleep(1)
            
        return {'articleList': all_articles}
        
    except Exception as e:
        print(f"[ERROR] Error in get_article_list: {str(e)}")
        return None

if __name__ == '__main__':
    with app.app_context():
        db.drop_all()
        db.create_all()
        create_admin()
        print("ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
    app.run(debug=True, host='0.0.0.0', port=5000)
